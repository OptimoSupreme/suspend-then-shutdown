#!/bin/sh
# Shutdown after being suspended for DELAY_SECS (systemd sleep hook).

# DELAY_SECS=2700    # 45 minutes
# DELAY_SECS=7200    #  2 hours
DELAY_SECS=14400   #  4 hours
# DELAY_SECS=28800   #  8 hours
# DELAY_SECS=        #  Custom

STAMP=/run/rtcwake_until

# returns 0 if on AC (skip shutdown), 1 if on battery
on_ac() {
  if command -v on_ac_power >/dev/null 2>&1; then
    on_ac_power
    return $?
  fi
  return 1
}

case "$2" in
  suspend|hybrid-sleep)
    case "$1" in
      pre)
        [ -n "$DELAY_SECS" ] || exit 0
        if rtcwake -m no -s "$DELAY_SECS" >/dev/null 2>&1; then
          now=$(date +%s)
          printf '%s\n' "$((now + DELAY_SECS))" > "$STAMP"
        fi
        ;;
      post)
        for f in /sys/class/rtc/rtc*/wakealarm; do echo 0 2>/dev/null > "$f"; done
        if [ -f "$STAMP" ]; then
          read -r until < "$STAMP" 2>/dev/null || until=0
          rm -f "$STAMP"
          now=$(date +%s)
          # 10-minute tolerance window
          if [ "$now" -ge "$until" ] && [ $((now - until)) -le 600 ]; then
            if ! on_ac; then
              systemd-run --unit=auto-shutdown --on-active=5s systemctl poweroff
            fi
          fi
        fi
        ;;
    esac
    ;;
esac
